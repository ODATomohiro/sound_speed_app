<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>音速測定（大きい波形＆自動スケール版）</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>音速測定（大きい波形＆自動スケール）</h1>
    <p class="sub">波形の縦スケールを「最大値」に自動で合わせて見やすく表示。管の長さ(D)を変えると即時に再計算。</p>
  </header>

  <main>
    <section class="card">
      <h2>1. デバイス</h2>
      <div class="grid.three" style="display:grid;grid-template-columns:1.2fr 1.2fr auto;gap:10px">
        <label>マイク（入力）
          <select id="micSelect"><option>（許可後に取得）</option></select>
        </label>
        <label>スピーカー（出力）
          <select id="spkSelect"><option>（対応ブラウザのみ）</option></select>
          <span class="small" id="spkNote"></span>
        </label>
        <div class="controls">
          <button id="btnStart">① マイク開始</button>
          <button id="btnRefresh">再検出</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>2. 設定</h2>
      <div class="grid three">
        <label>しきい値（自動検出）
          <input id="thresh" type="range" min="0.02" max="0.6" step="0.01" value="0.15">
          <span id="threshVal">0.15</span>
        </label>
        <label>最小遅延(ms)
          <input id="minGapMs" type="range" min="2" max="80" step="1" value="12">
          <span id="minGapVal">12</span>
        </label>
        <label>録音窓(ms)
          <input id="windowMs" type="range" min="100" max="3000" step="50" value="800">
          <span id="windowVal">800</span>
        </label>
        <label>パルス長(ms)
          <input id="pulseMs" type="range" min="1" max="30" step="1" value="5">
          <span id="pulseVal">5</span>
        </label>
        <div class="grid two" style="grid-template-columns:1fr 1fr">
          <label>振幅スケーリング
            <select id="ampMode">
              <option value="view" selected>表示範囲で自動</option>
              <option value="global">記録全体で自動</option>
              <option value="fixed">固定（手動）</option>
            </select>
          </label>
          <label id="gainWrap" style="display:none;">固定ゲイン（×）
            <input id="gain" type="range" min="0.1" max="10" step="0.1" value="1.0">
            <span id="gainVal">1.0×</span>
          </label>
        </div>
        <div class="legend">
          <label style="display:flex;align-items:center;"><input id="snapPeak" type="checkbox">クリック時に近傍ピークへスナップ</label>
        </div>
        <div class="controls">
          <button id="btnPulse" disabled>② パルス発音 + 記録</button>
          <button id="btnTestBeep" disabled>発音テスト</button>
          <button id="btnReset" class="secondary">リセット</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>3. 波形（時間軸・ズーム・パン）</h2>
      <div class="canvas-wrap">
        <canvas id="wave" width="1400" height="460" title="ホイール：ズーム / ドラッグ：パン / クリック：t1→t2 / ダブルクリック：t1→t2"></canvas>
      </div>
      <div class="legend">
        <div><span class="chip chip-t1"></span>t1 / <span class="chip chip-t2"></span>t2（縦線をドラッグで微調整）</div>
        <div>←/→ で最後に触ったマーカーを 1 サンプル（Shift で ×10）移動 / R でズームリセット</div>
      </div>
      <div class="grid two" style="margin-top:8px">
        <label>t1（ms）
          <div class="controls">
            <input id="t1ms" type="number" step="0.01" placeholder="例: 12.34">
            <button id="btnApplyT1">t1に適用</button>
          </div>
        </label>
        <label>t2（ms）
          <div class="controls">
            <input id="t2ms" type="number" step="0.01" placeholder="例: 45.67">
            <button id="btnApplyT2">t2に適用</button>
          </div>
        </label>
      </div>
      <div class="controls">
        <button id="btnAuto" disabled>自動検出</button>
        <button id="btnClearMarks" disabled>マーク削除</button>
        <button id="btnZoomReset" class="secondary">ズームリセット</button>
        <button id="btnPng" disabled>PNG保存</button>
      </div>
    </section>

    <section class="card">
      <h2>4. 計算（v = 2D / Δt）</h2>
      <div class="grid two">
        <label>管の長さ D（m）
          <input id="dist" type="number" step="0.01" value="2.00">
        </label>
      </div>
      <div class="results">
        <div>t1 = <span id="t1Val">–</span> ms</div>
        <div>t2 = <span id="t2Val">–</span> ms</div>
        <div>Δt = <span id="dtVal">–</span> ms</div>
        <div>v = <span id="vMeasured">–</span> m/s</div>
      </div>
      <div class="controls">
        <button id="btnCompute" disabled>計算</button>
        <button id="btnCsv" disabled>CSV出力</button>
      </div>
    </section>
  </main>

  <footer>
    <small>© 2025 音速測定アプリ（自動スケール版）</small>
  </footer>

  <script src="app.js"></script>
</body>
</html>
